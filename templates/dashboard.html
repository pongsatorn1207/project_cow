<!-- templates/dashboard.html -->
{% extends "base.html" %}
{% block title %}แดชบอร์ด{% endblock %}

{% block head_extra %}
<style>
  .card-img-top {
    border-radius: 8px;
    max-height: 220px;
    object-fit: cover;
  }
  .delete-btn {
    opacity: .92;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="mb-0">แดชบอร์ด</h3>
  <div class="d-flex gap-2">
    <form class="d-flex align-items-center gap-2" method="get" action="{{ url_for('dashboard') }}">
      <input type="date" class="form-control" name="date" value="{{ date_val or '' }}" style="max-width:170px">
      <input type="number" step="0.1" class="form-control" name="temp_min" value="{{ temp_min_val or '' }}" placeholder="กรอง ≥ อุณหภูมิ (°C)" style="max-width:200px">
      <input type="time" class="form-control" name="start_time" value="{{ start_time_val or '' }}" style="max-width:140px">
      <input type="time" class="form-control" name="end_time" value="{{ end_time_val or '' }}" style="max-width:140px">
      <button class="btn btn-secondary">ค้นหา</button>
    </form>
    <a class="btn btn-success"
       href="{{ url_for('download_xlsx', date=date_val, temp_min=temp_min_val, start_time=start_time_val, end_time=end_time_val) }}">
      ดาวน์โหลด Excel
    </a>
  </div>
</div>

{% if data|length == 0 %}
  <div class="alert alert-warning">ไม่พบข้อมูลตามเงื่อนไข</div>
{% endif %}

<div class="row g-4">
  {% for row in data %}
    <div class="col-md-4" id="card-col-{{ row['id'] }}">
      <div class="card shadow-sm position-relative" id="card-{{ row['id'] }}">
        <button type="button"
                class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 delete-btn"
                data-id="{{ row['id'] }}"
                title="ลบรูปนี้">ลบ</button>

        <img src="/{{ row['image_path'] }}" class="card-img-top" alt="image">
        <div class="card-body">
          <h5 class="card-title">อุณหภูมิ: {{ row['temperature'] }} °C</h5>
          <p class="card-text text-muted mb-0">เวลา: {{ row['timestamp'] }}</p>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}

{% block body_js %}
<script>
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('ลบรูปนี้ถาวร (ลบทั้งในฐานข้อมูลและไฟล์จริง)?')) return;
      const id = btn.dataset.id;
      try {
        const res = await fetch(`/delete_image/${id}`, { method: 'POST' });
        if (res.ok) {
          const cardCol = document.getElementById(`card-col-${id}`);
          if (cardCol) cardCol.remove();
        } else {
          const msg = await res.text();
          alert('ลบไม่สำเร็จ: ' + msg);
        }
      } catch (e) {
        alert('เกิดข้อผิดพลาดขณะลบรูป');
      }
    });
  });
</script>
{% endblock %}